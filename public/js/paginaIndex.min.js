const userLogin=async()=>{try{const e=await fetch("/api/public/userActive");if(!e.ok)throw new Error(`Error: ${e.status} ${e.statusText}`);const a=await e.json(),{data:t,error:i}=a;return i?(console.error("Error al cargar los datos:",i),!1):t}catch(e){return console.error("Error al realizar la solicitud:",e.message),!1}};class Buscador{constructor(e,a,t,i,s){this.init(e,a,t,i,s)}async init(e,a,t,i,s){this.buscadorInputDOM=e,this.paginacionDivDOM=a,this.selectFiltroEpocaSiembraDom=s,this.cardsDivDOM=t,this.domBtnSearch=i,this.isLoggedUser=await userLogin(),this.page=1,this.nameSeed="",this.buscador(),this.cargarPeticion()}async cargarPeticion(){this.peticion=`/api/public/paginateSeeds?page=${this.page}&nameseed=${this.nameSeed}&epocaSiembra=${this.selectFiltroEpocaSiembraDom.value}`;return await this.fetchAndLoadData()}async fetchAndLoadData(){this.cardsDivDOM.innerHTML='\n      <div id="spinner-container" class="d-flex justify-content-center align-items-center w-100" style="height: 525px;">\n        <div class="spinner-border text-dark" role="status">\n          <span class="visually-hidden">Cargando...</span>\n        </div>\n      </div>\n    ';try{const e=await fetch(this.peticion);if(!e.ok)throw new Error(`Error: ${e.status} ${e.statusText}`);const{data:a,error:t}=await e.json();if(!t){const{documentos:e,totalPaginas:t,paginaActual:i}=a;return this.cargarPaginacion(t,i),this.cargarCards(e),e}console.log("Error en la respuesta de la API:",t),this.cardsDivDOM.innerHTML="No se pudo cargar la información correctamente."}catch(e){console.error("Error al cargar los datos:",e),this.cardsDivDOM.innerHTML="Hubo un error al cargar los datos."}}buscador(){let e=!0,a=0;this.buscadorInputDOM.addEventListener("input",(async t=>{if(this.nameSeed=this.buscadorInputDOM.value.trim(),""==this.nameSeed&&(this.page=1,this.nameSeed="",e=!0,await this.cargarPeticion()),this.nameSeed.length>1&&e||this.nameSeed.length<a){this.page=1;const t=await this.cargarPeticion();e=t.length>0,e||(a=this.nameSeed.length),e||(this.cardsDivDOM.innerHTML="No hay semillas que coincidan con tu búsqueda.")}})),this.domBtnSearch.addEventListener("click",(async()=>{this.nameSeed=this.buscadorInputDOM.value.trim(),this.page=1,await this.cargarPeticion()})),this.buscadorInputDOM.addEventListener("keypress",(async e=>{"Enter"==e.key&&(this.nameSeed=this.buscadorInputDOM.value.trim(),this.page=1,await this.cargarPeticion())}))}cargarPaginacion(e,a){let t=this.paginacionDivDOM;if(t.classList.add("pagination"),t.innerHTML="",e>0){t.append(this.btnBeforePage(a));for(let i=1;i<=e;i++){const e=document.createElement("a");i==a&&(e.classList+="active "),e.classList+="page-link ",e.innerHTML+=i,e.addEventListener("click",(()=>{a!=i&&(this.page=i,this.cargarPeticion())}));const s=document.createElement("li");s.classList+="page-item",s.append(e),t.append(s)}t.append(this.btnAfterPage(a,e))}}cargarCards(e){if(e.length>0){this.cardsDivDOM.innerHTML="",e.forEach((({_id:e,fotoPath:a,nombre:t,nombreCientifico:i,tipoDeSuelo:s,descripcion:n,exposicionSolar:r,frecuenciaRiego:o,cantidadRiego:c,temperaturaIdeal:d,epocaSiembra:l,profundidadSiembra:b,espaciadoPlantas:u,tiempoGerminacion:m,tiempoCosecha:p,cuidadosPlantas:h,stock:v})=>{this.cardsDivDOM.innerHTML+=`\n            <div class="col">\n              <div class="card shadow-sm h-100">\n                <div id="carouselSemillas${e}" class="carousel slide" data-bs-ride="carousel">\n                  <div class="carousel-indicators">\n                    ${a.map(((a,t)=>`\n                      <button type="button" aria-label="Slider" data-bs-target="#carouselSemillas${e}" data-bs-slide-to="${t}" class="${0===t?"active":""}" aria-current="${0===t?"true":""}"></button>\n                    `)).join("")}\n                  </div>\n                  <div class="carousel-inner">\n                    ${a.map(((e,a)=>`\n                      <div class="carousel-item ${0===a?"active":""}">\n                        <img src="${e}" class="d-block w-100" height="300" alt="Foto de la semilla">\n                      </div>\n                    `)).join("")}\n                  </div>\n                  <button class="carousel-control-prev" type="button" data-bs-target="#carouselSemillas${e}" data-bs-slide="prev">\n                    <span class="carousel-control-prev-icon" aria-hidden="true"></span>\n                    <span class="visually-hidden">Previous</span>\n                  </button>\n                  <button class="carousel-control-next" type="button" data-bs-target="#carouselSemillas${e}" data-bs-slide="next">\n                    <span class="carousel-control-next-icon" aria-hidden="true"></span>\n                    <span class="visually-hidden">Next</span>\n                  </button>\n                </div>\n                <div class="card-body">\n                  <p class="card-title">${t}</p>\n                  <p class="card-text text-muted">${n}</p>\n                  <p class="mb-2">\n                    <span class="fw-bold"><i class="bi bi-calendar-event"></i> Época de siembra:</span> ${l}\n                  </p>\n                  <p class="mb-3">\n                    <span class="fw-bold"><i class="bi bi-box-seam"></i> Stock:</span> ${v} unidades disponibles\n                  </p>\n                  <div class="d-flex justify-content-between align-items-center">\n                    <div class="btn-group">\n                      <button type="button" class="btn btn-sm btn-outline-secondary btn-details" data-semilla-id="${e}">\n                        <i class="bi bi-eye"></i> Ver más detalles\n                      </button>\n                      <button type="button" class="btn btn-sm btn-outline-secondary btn-reservar" data-semilla-id="${e}" ${this.isLoggedUser?"":"disabled"}>\n                        <i class="bi-calendar"></i> Reservar\n                      </button>\n                    </div>\n                  </div>\n                </div>\n              </div>\n            </div>`}));document.querySelectorAll(".btn-reservar").forEach((e=>{e.addEventListener("click",(async function(){const a=e.getAttribute("data-semilla-id");try{const e=await fetch(`/api/public/seedId?seedId=${a}`);if(!e.ok)throw new Error("Error en la respuesta de la API: "+e.status);const t=await e.json(),{data:i,err:s}=t;if(s)console.error("Error recibido desde la API:",i);else{const{_id:e,nombre:a,stock:t}=i;document.querySelector("#reservarBox").innerHTML=`\n                    <div class="modal fade" id="reservaModal" aria-hidden="true">\n                      <div class="modal-dialog">\n                        <div class="modal-content">\n                          \x3c!-- Encabezado atractivo --\x3e\n                          <div class="modal-header bg-cuaternario text-white">\n                            <h1 class="modal-title fs-4">\n                              <i class="bi bi-calendar-check"></i> Reservar semilla: ${a}\n                            </h1>\n                            <button type="button" aria-label="modal" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>\n                          </div>\n\n                          <div class="modal-body p-4">\n                            <div class="row">\n                              <form id="reservationForm${e}" action="/me/reservas/${e}" method="POST" class="needs-validation" novalidate>\n                                \x3c!-- Cantidad de semillas --\x3e\n                                <div class="mb-4">\n                                  <label for="amountSeeds" class="form-label fw-bold">\n                                    <i class="bi bi-pencil-square"></i> Cantidad a reservar (Máx: ${t}):\n                                  </label>\n                                  <input \n                                    type="number" \n                                    class="form-control form-control-lg" \n                                    id="amountSeeds${e}" \n                                    name="amountSeeds" \n                                    min="1" \n                                    max="${t}" \n                                    required\n                                    placeholder="Ingrese la cantidad"\n                                  />\n                                  <div class="invalid-feedback">\n                                    Por favor ingrese una cantidad válida entre 1 y ${t}.\n                                  </div>\n                                </div>\n\n                                \x3c!-- Botón de reserva --\x3e\n                                <div class="d-grid">\n                                  <button type="submit" class="btn btn-lg btn-success shadow-sm">\n                                    <i class="bi bi-check-circle-fill"></i> Confirmar Reserva\n                                  </button>\n                                </div>\n                              </form>\n                            </div>\n                          </div>\n                        </div>\n                      </div>\n                    </div>\n                    `;new bootstrap.Modal(document.getElementById("reservaModal")).show()}}catch(e){console.error("Error durante la solicitud fetch:",e.message)}}))}));document.querySelectorAll(".btn-details").forEach((e=>{e.addEventListener("click",(async function(){const a=e.getAttribute("data-semilla-id");try{const e=await fetch(`/api/public/seedId?seedId=${a}`);if(!e.ok)throw new Error("Error en la respuesta de la API: "+e.status);const t=await e.json(),{data:i,err:s}=t;if(s)console.error("Error recibido desde la API:",i);else{const{_id:e,nombre:a,stock:t,nombreCientifico:s,fotoPath:n,descripcion:r,tipoDeSuelo:o,exposicionSolar:c,frecuenciaRiego:d,cantidadRiego:l,temperaturaIdeal:b,epocaSiembra:u,profundidadSiembra:m,espaciadoPlantas:p,tiempoGerminacion:h,tiempoCosecha:v,cuidadosPlantas:g}=i;document.querySelector("#detallesBox").innerHTML=`\n                <div class="modal modal-xl fade" id="details" aria-hidden="true">\n                  <div class="modal-dialog">\n                    <div class="modal-content">\n                      <div class="modal-header bg-cuaternario">\n                        <h1 class="modal-title fs-5 text-light" id="exampleModalLabel">Detalles Semilla: ${a}</h1>\n                        <button type="button"  aria-label="close" class="btn-close" data-bs-dismiss="modal"></button>\n                      </div>\n                      <div class="modal-body">\n                        \n                        <h4 class="mb-3">\n                          <i class="bi bi-leaf"></i> ${a}\n                          <small class="text-muted">(${s||"Nombre científico no disponible"})</small>\n                        </h4>\n                        <p><span class="fw-bold"><i class="bi bi-file-text"></i> Descripción:</span> ${r}</p>\n                        <p><span class="fw-bold"><i class="bi bi-box-seam"></i> Stock disponible:</span>\n                          <span class="badge bg-cuaternario">${t}</span>\n                        </p>\n                        <h5 class="mb-4"><i class="bi bi-info-circle"></i> Información Adicional</h5>\n                        <table class="table table-striped">\n                          <tbody>\n                            <tr><th><i class="bi bi-geo-alt"></i> Tipo de suelo</th><td>${o||"No especificado"}</td></tr>\n                            <tr><th><i class="bi bi-brightness-high"></i> Exposición solar</th><td>${c||"No especificado"}</td></tr>\n                            <tr><th><i class="bi bi-droplet"></i> Frecuencia de riego</th><td>${d||"No especificado"}</td></tr>\n                            <tr><th><i class="bi bi-droplet-half"></i> Cantidad de riego</th><td>${l||"No especificado"} ml</td></tr>\n                            <tr><th><i class="bi bi-thermometer"></i> Temperatura ideal</th><td>${b||"No especificado"} °C</td></tr>\n                            <tr><th><i class="bi bi-calendar"></i> Época de siembra</th><td>${u||"No especificado"}</td></tr>\n                            <tr><th><i class="bi bi-box"></i> Profundidad de siembra</th><td>${m||"No especificado"}</td></tr>\n                            <tr><th><i class="bi bi-arrows-expand"></i> Espaciado entre plantas</th><td>${p||"No especificado"} cm</td></tr>\n                            <tr><th><i class="bi bi-clock"></i> Tiempo de germinación</th><td>${h||"No especificado"} días</td></tr>\n                            <tr><th><i class="bi bi-clock-history"></i> Tiempo de cosecha</th><td>${v||"No especificado"} días</td></tr>\n                            <tr><th><i class="bi bi-heart"></i> Cuidados de la planta</th><td>${g||"No especificado"}</td></tr>\n                          </tbody>\n                        </table>\n\n                        <div class="row mb-4">\n                          <h3>Galería:</h3>\n                          <div class="col-md-12">\n                            <div class="row">\n                              ${n.map((e=>`\n                                <div class="col-md-3 mb-3 text-center">\n                                  <img src="${e}" alt="Foto de la semilla" class="img-fluid rounded shadow-sm">\n                                </div>\n                              `)).join("")}\n                            </div>\n                          </div>\n                        </div>\n\n                      </div>\n                    </div>\n                  </div>\n                </div>\n\n                    `;new bootstrap.Modal(document.getElementById("details")).show()}}catch(e){console.error("Error durante la solicitud fetch:",e.message)}}))}))}else this.cardsDivDOM.innerHTML="No se encontraron semillas."}btnBeforePage(e){const a=document.createElement("li");return a.classList.add("page-item"),a.innerHTML='<a class="page-link">\n                          <span aria-hidden="true">&laquo;</span>\n                        </a>',a.addEventListener("click",(()=>{e>1&&(this.page=Number(e)-1,this.cargarPeticion())})),a}btnAfterPage(e,a){const t=document.createElement("li");return t.classList.add("page-item"),t.innerHTML='<a class="page-link">\n                          <span aria-hidden="true">&raquo;</span>\n                        </a>',t.addEventListener("click",(()=>{e<a&&(this.page=Number(e)+1,this.cargarPeticion())})),t}}const btnSaveFilterEpocaSiembra=document.querySelector("#btn_guardar_filtro_epoca_siembra"),filterLocalStore=localStorage.getItem("filtro"),domFilterEpocaSiembra=document.querySelector("#select_epoca_siembra"),domBtnSearch=document.querySelector("#sendSearch"),domCardsSeeds=document.querySelector("#boxSeeds"),domPaginationSearch=document.querySelector("#paginacion"),domInputSearch=document.querySelector("#buscador"),buscador=new Buscador(domInputSearch,domPaginationSearch,domCardsSeeds,domBtnSearch,domFilterEpocaSiembra);btnSaveFilterEpocaSiembra.addEventListener("click",(()=>{localStorage.setItem("filtro",domFilterEpocaSiembra.value)})),domFilterEpocaSiembra.addEventListener("input",(()=>{buscador.page=1,buscador.cargarPeticion()})),filterLocalStore?domFilterEpocaSiembra.querySelectorAll("option").forEach((e=>{filterLocalStore==e.getAttribute("value")&&e.setAttribute("selected",!0)})):domFilterEpocaSiembra.querySelectorAll("option")[0].setAttribute("selected",!0);